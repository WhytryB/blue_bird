{% extends 'base.html' %}

{% block title %}Home Page{% endblock %}
{% block extra_styles %}
<link rel="stylesheet" href="../static/css/plugins/select2.min.css">
{% endblock %}
{% block content %}
        <!--Sidebar End-->
        <!-- Main Content Area Start -->
        <main>
            <div class="main-wrapper">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-8">

                            <div class="card p-20px mb-25px">

                                <div class="card-title text-uppercase font-weight-bold font-15px">Інформація</div>
                                <div >


                                <div id="selected_kv_data" class="ui-tabs-panel">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered">
                                            <thead>
                                            <tr>
                                                <th style="padding-top: 20px; padding-bottom: 20px;" rowspan="2" class="text-uppercase text-center font-12px">Квартира</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Дім</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Тип</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Під'їзд</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Поверх</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Площа</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Кількість Комнат</th>
                                            </tr>


                                            </thead>
                                            <tbody>
                                                 <tr>

                                                    <td class="font-14px text-center">{{selected_kv_data.name}}</td>
                                                    <td class="font-14px text-center">{{selected_kv_data.Дом}}</td>
                                                    <td class="font-14px text-center">{{selected_kv_data.ЖилойФонд}}</td>
                                                    <td class="font-14px text-center">{{selected_kv_data.Подъезд}}</td>

                                                     <td class="font-14px text-center">{{selected_kv_data.Этаж}}</td>
                                                    <td class="font-14px text-center">{{selected_kv_data.Площадь}}</td>
                                                     <td class="font-14px text-center">{{selected_kv_data.КоличествоКомнат}}</td>



                                                 </tr>


                                            </tbody>
                                        </table>
                                    </div>
                                </div>


                                </div>
                            </div>


                            <div class="card p-20px mb-25px">

                                <div class="card-title text-uppercase font-weight-bold font-15px">Рахунок    <a style="float: right !important;" class=" print_schet btn btn-sm btn-outline-primary">друк рахунку</a></div>
                                <div >
                                    <ul class="tab-navigation inline pill ui-tabs-panel">
                                        <li><a class="font-weight-bold">Оберіть дату </a></li>
                                        <li>

                                            <select id="select-rachet">

                                                {% for item in raschet %}
                                                <option value={{item.month}}>{{item.month_name}}</option>
                                                {% endfor %}

                                            </select>

                                        </li>
                                    </ul>
                                <div id="messages-table" class=""></div>
                                {% for item in raschet %}
                                <div id={{item.month}} class="ui-tabs-panel dynamic-table" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered">
                                            <thead>
                                            <tr>
                                                <th style="padding-top: 20px; padding-bottom: 20px;" rowspan="2" class="text-uppercase text-center font-12px">Найменування</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Од. Вим.</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Значення</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Тариф</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Нараховано</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Сплачено</th>
                                                <th rowspan="2" class="text-uppercase text-center font-12px">Долг</th>
                                            </tr>


                                            </thead>
                                            <tbody>

                                                 {% for yslyga in item.services %}
                                                 <tr>

                                                    <td class="font-14px">{{yslyga.name}}</td>
                                                    <td class="font-14px">{{yslyga.единица}}</td>
                                                    <td class="font-14px">{{yslyga.quantity_narah}}</td>
                                                    <td class="font-14px">{{yslyga.тариф}}</td>

                                                     <td class="font-14px">{{yslyga.нарах}}</td>
                                                    <td class="font-14px">{{yslyga.оплата}}</td>
                                                     <td class="font-14px">{{yslyga.долг}}</td>



                                                 </tr>

                                                 {% endfor %}
                                                  <tr>

                                                    <td class="font-14px">Всього</td>
                                                    <td class="font-14px"></td>
                                                    <td class="font-14px"></td>
                                                    <td class="font-14px"></td>
                                                      <td class="font-14px">{{ item.month_nachislenie}}</td>
                                                    <td class="font-14px">{{ item.month_oplata }}</td>
                                                      <td class="font-14px">{{ item.month_dolg }}</td>



                                                 </tr>

                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endfor %}

                                </div>
                            </div>
                            <div class="card p-20px mb-25px">
                                <div class="card-title text-uppercase font-weight-bold font-15px">Комунальні послуги</div>
                                <div class="card-body" id="tabs-v3">

                                    <ul style=" overflow-x: auto; white-space: nowrap; " class="tab-navigation inline pill">
                                        <li><a href="#tabs1">2024 Разрахунок</a></li>
                                        <li><a href="#tabs2">2023 Разрахунок</a></li>

                                    </ul>
                                    <div style="    width: 100%; height: 400px; /* Задайте желаемую высоту */">
                                        <canvas id="tabs1" class="pt-20px"></canvas>
                                        <canvas id="tabs2" class="pt-20px"></canvas>

                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card mb-25px">
                                <div class="widget-card">
                                    <div class="widget-card-wrapper" style="padding-bottom: 0;">
                                        <div class="title mb-15px">
                                            <h4 class="font-15px text-uppercase font-weight-bold">Пов'язані об'єкти</h4>

                                        </div>
                                        <div class="kwartira">
                                            <select class="select3">

                                                {% for item in lich %}
                                                    <option value="{{ item.codes }}">
                                                        {{ item.names }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <p class="text-secondary font-14px">Оберіть рахунок</p>
                                    </div>
                                    <svg style="position: relative" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 250"><path fill="#6c757d" fill-opacity="1" d="M0,224L48,218.7C96,213,192,203,288,208C384,213,480,235,576,202.7C672,171,768,85,864,90.7C960,96,1056,192,1152,213.3C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>
                                </div>
                            </div>
                            <div class="card mb-25px">
<!--                                <div class="card-title text-uppercase font-weight-bold font-15px">Patient Statistics</div>-->
<!--                                <div class="card-body">-->
<!--                                    <canvas id="chart1"></canvas>-->
<!--                                </div>-->
                                <div class="widget-card">
                                    <div class="widget-card-wrapper" style="padding-bottom: 0;">
                                        <div class="title mb-15px">
                                            <h4 class="font-15px text-uppercase font-weight-bold">Стан рахунку</h4>
                                            <p class="text-secondary font-14px">Дата початку:	2023-07-01</p>
                                        </div>
                                        <div class="row">
                                            <div class="col-8">
                                                <div class="number-text font-weight-bold font-30px">Залишок: {{ostatok}}</div>
                                                <p class="text-secondary font-14px pb-10px">Дата оновлення:	{{formatted_datetime}}</p>

                                            </div>
                                            <div class="col-4">
                                                <div class="number-text font-weight-bold font-30px"> <a  href="/payment" type="button" class="btn btn-lg btn-primary">Оплатити</a></div>

                                            </div>
                                        </div>

                                    </div>

                                    <svg style="position: relative;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 250"><path fill="#0099ff" fill-opacity="1" d="M0,96L30,112C60,128,120,160,180,176C240,192,300,192,360,197.3C420,203,480,213,540,186.7C600,160,660,96,720,106.7C780,117,840,203,900,202.7C960,203,1020,117,1080,101.3C1140,85,1200,139,1260,160C1320,181,1380,171,1410,165.3L1440,160L1440,320L1410,320C1380,320,1320,320,1260,320C1200,320,1140,320,1080,320C1020,320,960,320,900,320C840,320,780,320,720,320C660,320,600,320,540,320C480,320,420,320,360,320C300,320,240,320,180,320C120,320,60,320,30,320L0,320Z"></path></svg>
                                </div>
                            </div>


                            <div class="card p-20px mb-25px">
                                <div class="card-title text-uppercase font-weight-bold font-15px">Історія за минулі періоди за загальною сумою </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered">
                                            <thead class="thead-dark">
                                                <tr>
                                                    <th class="text-uppercase font-12px">Дата</th>
                                                    <th class="text-uppercase font-12px">Нараховано</th>
                                                    <th class="text-uppercase font-12px">Сплачено</th>

                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in obw_summa %}
                                                <tr>
                                                    <td class="font-14px pt-15px pb-15px">{{item.second_month_name}}</td>
                                                    <td class="font-14px pt-15px pb-15px">{{item.month_nachislenie}} грн</td>
                                                    <td class="font-14px pt-15px pb-15px">{{item.month_oplata}} грн</td>

                                                </tr>
                                                {% endfor %}


                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <!-- Main Content Area End-->
        <footer class="footer">
            <div class="copyright text-center">

            </div>
        </footer>
    </div>
{% endblock %}
{% block scripts %}
{% csrf_token %}
<!--    <script src="-->
<!--https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js-->
<!--"></script>-->

    <script src="../static/js/plugins/chart.min.js"></script>
    <script src="../static/js/plugins/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $( "#tabs-v3" ).tabs();
            var select_rachet = $('#select-rachet');
            select_rachet.select2({
                placeholder: 'Виберіть дату',
                dropdownPosition: 'below',
                dropdownCssClass: 'select2-height'
            });


            $('.select3').select2({
                placeholder: 'Виберіть  об\'єкт',
                dropdownPosition: 'below',
                dropdownCssClass: 'select2-height'
            });

            var selectedValue = '{{ lich_selected }}';


            $('.select3').val(selectedValue).trigger('change');



            $('.select3').on('change', function () {
                  var selectedValue = $(this).val();

                  var dataArray = {{lich | safe }};

                  // Поиск объекта с codes равным "42"
                  var selectedObject = dataArray.find(function(item) {
                    return item.codes === selectedValue;
                  });

                    // Выбор поля names найденного объекта
                  var selectedName = selectedObject ? selectedObject.names : null;

                  var csrf_token = $('[name="csrfmiddlewaretoken"]').val();

                  // Выполнить асинхронный запрос к Django view
                  $.ajax({
                    url: '/set_lich/',  // Замените на реальный URL вашего Django view
                    method: 'POST',
                    data: { selected_value: selectedValue, selected_value_content: selectedName },
                    headers: { "X-CSRFToken": csrf_token },
                    success: function (data) {
                          // Обработать успешный ответ
                          console.log('Куки обновлены');
                          window.location.reload();
                        },
                    error: function (error) {
                      // Обработать ошибку
                      console.error('Ошибка при обновлении кук');
                    }
                  });
            });






            select_rachet.on('change', function() {
                // Получаем выбранное значение
                var selectedValue = $(this).val();

                // Скрываем все таблицы
                $('.dynamic-table').hide();
                console.log("test", selectedValue)

                // Отображаем выбранную таблицу
                $('#' + selectedValue).show();
            });

            var isInitialized = false;



            // Проверяем, был ли код уже выполнен
            if (!isInitialized) {
                var selectedValue = select_rachet.val();
                // Скрываем все таблицы
                $('.dynamic-table').hide();

                // Отображаем выбранную таблицу
                $('#' + selectedValue).show();

                // Устанавливаем флаг, чтобы код больше не выполнялся
                isInitialized = true;
            }


            new Chart(document.getElementById('tabs1'), {
                type: 'bar',
                data: {
                    labels: {{available_months_list_2024|safe}},
                    datasets: {{yslygi_2024_chart|safe}}
                },
                options: {
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x', // Разрешить горизонтальное прокручивание
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                  },
                                pinch: {
                                    enabled: true
                                  },
                                enabled: true,
                                mode: 'x', // Разрешить горизонтальное масштабирование
                            }
                        }
                    }
                },
            });



            new Chart(document.getElementById('tabs2'), {
                type: 'bar',
                data: {
                    labels: {{available_months_list_2023|safe}},
                    datasets: {{yslygi_2023_chart|safe}}
                    // datasets: [
                    //     {
                    //         label: 'Електроенергія ',
                    //         data: [420, 150, 320, 50, 250, 120, 170, 164, 145, 135, 110, 185],
                    //         backgroundColor: [
                    //             '#dcc424',
                    //         ],
                    //         hoverOffset: 4
                    //     },{
                    //         label: 'Теплова енергія ',
                    //         data: [320, 150, 320, 150, 250, 120, 170, 164, 145, 135, 110, 185],
                    //         backgroundColor: [
                    //             '#c90000',
                    //         ],
                    //         hoverOffset: 4
                    //     },{
                    //         label: 'Вода',
                    //         data: [220, 150, 120, 50, 250, 120, 170, 164, 145, 135, 110, 185],
                    //         backgroundColor: [
                    //             '#008be8',
                    //         ],
                    //         hoverOffset: 4
                    //     },
                    //     {
                    //         label: 'Газ',
                    //         data: [200, 170, 300, 50, 350, 120, 165, 225, 245, 187, 194, 136],
                    //         backgroundColor: [
                    //             '#878e98'
                    //         ],
                    //         hoverOffset: 4
                    //     }
                    // ]
                },
                options: {
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                },
            });


            function sevePrint(visibleSelect, main){
            var postData = undefined;
            main.forEach(function(item) {
                if (item.month == visibleSelect) {
                    postData = item
                }
            });

            $('#messages-table').empty();


            // Выполняем POST-запрос
            $.ajax({
                type: 'POST',
                url: '/',
                data: {data: JSON.stringify(postData)},
                headers: { 'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val() },
                success: function(response) {
                      // Очищаем контейнер сообщений перед добавлением новых сообщений

                      if (response) {

                            var link = document.createElement('a');
                            link.href = response.file_url;
                            link.download = 'document.pdf'; // Имя файла для скачивания
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);

                        } else {
                            // Обработка ошибки
                            $('#messages-table').append('<div class="alert ' + 'alert-danger' + '" role="alert">' + 'Показання не оновлені' + '</div>');
                        }
                },
                error: function(xhr, status, error) {
                    $('#messages-table').append('<div class="alert ' + 'alert-danger' + '" role="alert">' + 'Показання не оновлені' + '</div>');
                    console.error('Произошла ошибка при выполнении запроса', error);

                }
            });

        }


        $('.print_schet').on('click', function() {


            var visibleSelect = $('#select-rachet').val();
            var mainData = "{{raschet|safe}}";

            var main = JSON.parse(mainData.replaceAll("\'","\""));
            sevePrint(visibleSelect, main)

        });


        });



    </script>
{% endblock %}
